# STM32F407 FreeRTOS Проект

## Описание

Проект представляет собой приложение на базе микроконтроллера **STM32F407VG** с операционной системой реального времени **FreeRTOS v10.3.1**. Проект реализует многозадачную систему с мониторингом переключения задач через GPIO.

## Аппаратное обеспечение

- **MCU**: STM32F407VG (ARM Cortex-M4, 168 МГц)
- **ОЗУ**: До 192 кБ (128 кБ SRAM + 64 кБ CCM)
- **Flash память**: 1 МБ
- **GPIO**: Порт A (PA0-PA5) используется для мониторинга

## Программное обеспечение

- **FreeRTOS**: v10.3.1
- **HAL**: STM32F4xx HAL Library
- **Компилятор**: GCC (ARM Embedded Toolchain)
- **IDE**: STM32CubeIDE

## Основные компоненты

### Задачи

Система содержит 4 основные задачи:

| Задача | Приоритет | Стек (байт) | Описание |
|--------|-----------|-------------|---------|
| `myTask01` | Normal | 128 | Ожидает уведомления, затем блокируется |
| `myTask02` | Normal | 128 | Ожидает уведомления, затем блокируется |
| `myTask03` | Normal | 128 | Отправляет уведомления другим задачам каждые 10 мс |
| `myTask04` | AboveNormal | 128 | Ожидает уведомления, затем блокируется |

### Конфигурация FreeRTOS

Ключевые параметры в `FreeRTOSConfig.h`:

```c
configTICK_RATE_HZ          1000        // 1 кГц тактовая частота
configMAX_PRIORITIES        7           // Максимум 7 приоритетов
configTOTAL_HEAP_SIZE       15360       // 15 КБ динамической памяти
configMINIMAL_STACK_SIZE    128         // Минимальный размер стека
```

### Мониторинг задач

Система использует GPIO для отладки и мониторинга:

- **PA0-PA3**: Состояние задач 1-4 (HIGH при активной задаче, LOW при ожидании)
- **PA4**: Индикатор активности холостого хода (Idle)
- **PA5**: Индикатор тактирования системы (каждое прерывание SysTick)

#### Макросы управления

```c
#define TASK_DEBUG      // Включить мониторинг переключения задач
#define IDDLE_MON       // Включить мониторинг холостого хода
```

## Взаимодействие задач

**Поток выполнения:**

1. `myTask03` каждые 10 мс отправляет уведомления:
   - `xTaskNotifyGive(myTask04Handle)` - уведомляет задачу 4
   - `xTaskNotifyGive(myTask01Handle)` - уведомляет задачу 1
   - `xTaskNotifyGive(myTask02Handle)` - уведомляет задачу 2

2. Задачи 1, 2, 4 получают уведомление и пробуждаются:
   ```c
   ulTaskNotifyTake(0, portMAX_DELAY)  // Ожидание уведомления
   ```

3. После выполнения задачи возвращаются в режим ожидания

## Прерывания

### SysTick Handler

Обработчик системного тика (`SysTick_Handler` в `stm32f4xx_it.c`):
- Вызывает `HAL_IncTick()` для обновления системного таймера
- Вызывает `xPortSysTickHandler()` для переключения контекста FreeRTOS
- Генерирует импульс на PA5 для диагностики

### Системные прерывания

Приоритеты прерываний:

```c
configLIBRARY_LOWEST_INTERRUPT_PRIORITY             15
configLIBRARY_MAX_SYSCALL_INTERRUPT_PRIORITY        5
```

## Структура проекта

```
├── Inc/
│   ├── FreeRTOSConfig.h          // Конфигурация FreeRTOS
│   ├── main.h                     // Основной заголовок
│   ├── stm32f4xx_hal_conf.h      // Конфигурация HAL
│   ├── stm32f4xx_it.h            // Заголовки обработчиков прерываний
├── Src/
│   ├── main.c                     // Основная программа, определение задач
│   ├── freertos.c                 // Инициализация памяти FreeRTOS
│   ├── stm32f4xx_it.c            // Обработчики прерываний
│   ├── stm32f4xx_hal_msp.c       // HAL MSP инициализация
│   ├── system_stm32f4xx.c        // Инициализация системы
│   ├── syscalls.c                 // Системные вызовы
│   └── sysmem.c                   // Управление памятью
└── Startup/
    └── startup_stm32f407vgtx.s    // Стартовый код (Assembly)
```

## Поддерживаемые возможности FreeRTOS

Включенные функции (в `FreeRTOSConfig.h`):

- ✅ Вытесняющая многозадачность (`configUSE_PREEMPTION`)
- ✅ Статическое и динамическое распределение памяти
- ✅ Хуки холостого хода и тактирования
- ✅ Мьютексы и подсчитывающие семафоры
- ✅ Таймеры ПО
- ✅ Очереди сообщений
- ✅ Теги задач для отладки
- ✅ Оптимизация выбора задачи через порты
